sudo: true

language: go

go: 
  - 1.9.2

go_import_path: github.com/goharbor/harbor

services: 
  - docker

dist: trusty

matrix:
  include:
  - go: "1.10"
    env:
    - UTTEST=true
  - go: "1.10"
    env:
    - APITEST_DB=false
  - go: "1.10"
    env:
    - APITEST_LDAP=false

env:
  global:
    - POSTGRESQL_HOST: localhost
    - POSTGRESQL_PORT: 5432
    - POSTGRESQL_USR: postgres
    - POSTGRESQL_PWD: root123
    - POSTGRESQL_DATABASE: registry
    - ADMINSERVER_URL: http://127.0.0.1:8888
    - DOCKER_COMPOSE_VERSION: 1.7.1
    - HARBOR_ADMIN: admin
    - HARBOR_ADMIN_PASSWD: Harbor12345
    - UI_SECRET: tempString
    - KEY_PATH: /data/secretkey
    - REDIS_HOST: localhost
    - REG_VERSION: v2.6.2
    - UI_BUILDER_VERSION: 1.6.0
    - secure: "IcWloGUqJfGT4AietOBKGk9yjK220L0WVAiwGEoy90YWA8BO9i2WibVNpmmjvQKaF6w1YDuO4tiZpN9kvhwzJN4a+83+3OMzVwvNI9HV+ChV2aj4ZIWKhBoMCG/SSJTA4mzdp4eL0YmQMG8gYqliwc/5q5f766j/BXaPt3y/kq7vtLbXXe1vwVrYpj5NiF4Q/bLpFYzg1SoGM4pajWIRNaavXAqomOYBd07Sn4iJYfA2UdoKIP8C024Y9Ct8Dif/Ny9y2LWYDGlz89nCjB5G1dLODKj2F1F0MIiI7XhBdWS3c4ofrB25nE26cLE0Ze4UwuWHBtnOgDy+JcI367NTjp8tDXajkoApT2s4POuIyHRCNDRbRmYb3TxF2AUI5PvVe0c6Id3RLtJa8aLN7BxRgIbT2iUoXWzKYYHorwRIgfqNI3UVjNiT7YlVQ/QWzOdGkfQeXHiigQvGFtvzUpSdU3M4huLCBXmfrJBlfF4M1kEED+Ozr3BqoLAlX1oV+/wYhBO51hApvgSWqNkOf2sZmFodvl8hiXcNg4ZVH70Uh3lfJ0EF6+Ts3AdLwsp6LkLZ8rTgBubLSox3/sJ8eigrv2iTwjSnM02BpeyVTmgPgQAQ7R5eA/IHOR1ilb3juFPJnUisP98axaXYD/ZDmUvQPLvaSxCianmCxqvx0sDwRjw="


before_install:
   - echo $yantest
   - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
   - chmod +x docker-compose
   - sudo mv docker-compose /usr/local/bin
   - IP=`ip addr s eth0 |grep "inet "|awk '{print $2}' |awk -F "/" '{print $1}'`
   - sudo sed -i '$a DOCKER_OPTS=\"--insecure-registry '$IP':5000\"' /etc/default/docker
   - export IP=$IP
   - sudo service docker restart

install:
   - if [ "$UTTEST" == true ]; then bash ./tests/travis/ut_install.sh ; fi
   - if [ "$APITEST_DB" == true ]; then bash ./tests/travis/api_db_install.sh $IP ; fi
   - if [ "$APITEST_LDAP" == true ]; then bash ./tests/travis/api_ldap_install.sh $IP ; fi

script:
  - if [ "$UTTEST" == true ]; then bash ./tests/travis/ut_run.sh $IP; fi
  - if [ "$APITEST_DB" == true ]; then bash ./tests/travis/api_run.sh DB $IP; fi
  - if [ "$APITEST_LDAP" == true ]; then bash ./tests/travis/api_run.sh LDAP $IP; fi